<!doctype html>
<html>
  <head>
    <style>
      html, body {
        margin: 0;
        padding: 0;
      }
    </style>
    <script src="../build/isf.js"></script>
    <script>
      window.addEventListener("load", function() {
        var source = document.getElementById("isf-source").textContent;
        var canvas = document.getElementById("output");
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        var gl = canvas.getContext("webgl");
        var renderer = new ISFRenderer(gl);
        var parser = new ISFParser()
        parser.parse(source);
        renderer.sourceChanged(parser.fragmentShader, parser.vertexShader, parser);
        var time = 0;
        renderer.setValue("master_zoom", 1.0);
        renderer.setValue("red_zoom", 1.0);
        renderer.setValue("blue_zoom", 1.3);
        renderer.setValue("green_zoom", 1.5);
        renderer.setValue("center", [0.5, 0.5]);
        var image = document.createElement("img");
        image.src = "./tycho.png"
        image.crossOrigin = "anonymous"
        renderer.setValue("inputImage", image)

        var animate = function () {
          renderer.setValue("inputImage", image)
          renderer.setValue("TIME", time)
          renderer.draw(canvas);
          time += 0.01;
          requestAnimationFrame(animate);
        }
        animate();
      })
    </script>
  </head>
  <body>
      <canvas id="output"></canvas>
      <script id="isf-source" type="text/isf">

      /*{
      	"CREDIT": "by toneburst",
      	"CATEGORIES": [
      		"Toneburst", "Stylize"
      	],
      	"INPUTS": [
      		{
      			"NAME": "inputImage",
      			"TYPE": "image"
      		},
      		{
      			"NAME": "master_zoom",
      			"TYPE": "float",
      			"MIN": 0.1,
      			"MAX": 2.0,
      			"DEFAULT": 1.0
      		},
      		{
      			"NAME": "red_zoom",
      			"TYPE": "float",
      			"MIN": 1.0,
      			"MAX": 1.5,
      			"DEFAULT": 1.0
      		},
      		{
      			"NAME": "green_zoom",
      			"TYPE": "float",
      			"MIN": 1.0,
      			"MAX": 1.5,
      			"DEFAULT": 1.0
      		},
      		{
      			"NAME": "blue_zoom",
      			"TYPE": "float",
      			"MIN": 1.0,
      			"MAX": 1.5,
      			"DEFAULT": 1.0
      		},
      		{
      			"NAME": "center",
      			"TYPE": "point2D",
      			"DEFAULT": [
      				0.5,
      				0.5
      			]
      		}
      	]
      }*/

      void main() {
      	vec2		loc;
      	vec2		modifiedCenter;

      	loc = vv_FragNormCoord;
      	modifiedCenter = center / RENDERSIZE;

      	vec2 locR = (loc - modifiedCenter)*(1.0/(red_zoom*master_zoom)) + modifiedCenter;
      	vec2 locG = (loc - modifiedCenter)*(1.0/(green_zoom*master_zoom)) + modifiedCenter;
      	vec2 locB = (loc - modifiedCenter)*(1.0/(blue_zoom*master_zoom)) + modifiedCenter;

      	vec4 outPix;
      	outPix.r = IMG_NORM_PIXEL(inputImage,locR).r;
      	outPix.g = IMG_NORM_PIXEL(inputImage,locG).g;
      	outPix.b = IMG_NORM_PIXEL(inputImage,locB).b;

      	loc.x = (loc.x - modifiedCenter.x)*(1.0/master_zoom) + modifiedCenter.x;
      	loc.y = (loc.y - modifiedCenter.y)*(1.0/master_zoom) + modifiedCenter.y;

      	outPix.a = IMG_NORM_PIXEL(inputImage,loc).a;
      	gl_FragColor = outPix;
      }

      </script>
  </body>
</html>
